---
title: "OpenAPIå®šç¾©ã‹ã‚‰"
emoji: "ğŸ•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["TypeScript", "openapitypescript", "Nodejs"]
published: false
---
## ã¯ã˜ã‚ã«

OpenAPI Specificationï¼ˆä»¥ä¸‹ã€OASï¼‰ã¯ã€ä¸€èˆ¬çš„ã«APIä»•æ§˜ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ´»ç”¨ã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ãŒå¤šã„ã¨æ€ã„ã¾ã™ã€‚
ã—ã‹ã—OASã«ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä»¥å¤–ã«ã‚‚ã€æ§˜ã€…ãªæ´»ç”¨æ–¹æ³•ãŒå­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€Swagger.ioã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‹ã‚‰å¼•ç”¨ã—ã¦ã„ã¾ã™ã€‚

ã¾ãŸOASã¯ã€ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£è£½ã®ãƒ„ãƒ¼ãƒ«ã‚‚è±Šå¯Œã§ã™ã€‚

ç§ãŒæºã‚ã£ã¦ã„ã‚‹ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã¯ã€OASãŒé–‹ç™ºåˆæœŸã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸€éƒ¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã¨ã—ã¦åˆ©ç”¨ã—ã¦ã„ã¾ã—ãŸã€‚
ä»Šå›æ–°ãŸãªã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£è£½ã®ãƒ„ãƒ¼ãƒ«ã‚’å°å…¥ã—ã¦ã€OASã®ä¸‹è¨˜ã®ã‚ˆã†ãªæ´»ç”¨ã‚’å›³ã‚Šã¾ã—ãŸã€‚
1. **OASã‹ã‚‰typescriptå‹å®šç¾©ã‚’ç”Ÿæˆã—ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ»ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å…±ç”¨ã™ã‚‹**
2. **APIã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«OASã‚’ç”¨ã„ã‚‹**

ãªãŠã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ãŠãŠã¾ã‹ãªæŠ€è¡“æ§‹æˆã¯ä¸‹è¨˜ã«ãªã‚Šã¾ã™ã€‚
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯Next.jsã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯Expressã§APIã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã‚‹æ§‹æˆã§ã™ã€‚


## OASã‹ã‚‰typescriptå‹å®šç¾©ã‚’ç”Ÿæˆã—ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ»ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å…±ç”¨ã™ã‚‹
### è§£æ±ºã—ãŸã‹ã£ãŸèª²é¡Œ
ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã¯ã€ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã§ã‚¹ãƒ”ãƒ¼ãƒ‰é‡è¦–ã§é–‹ç™ºãŒé€²ã‚ã‚‰ã‚Œã¦ã„ãŸã“ã¨ã‚‚ã‚ã‚Šã€æ§˜ã€…ãªå•é¡ŒãŒæ½œã‚“ã§ã„ã¾ã—ãŸã€‚
ãã®ä¸€ã¤ã¨ã—ã¦ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹å®šç¾©ãŒå®Ÿæ…‹ã¨ããã‚ãšã€ãƒã‚°ã®æ¸©åºŠã‚„é–‹ç™ºåŠ¹ç‡ã‚’ä½ä¸‹ã•ã›ã¦ã„ã‚‹ã¨ã„ã†èª²é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚

OASã‹ã‚‰ç”Ÿæˆã—ãŸå‹ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ»ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å…±æœ‰ã™ã‚‹ã“ã¨ã§ã€å‹ã®å®‰å…¨æ€§ã‚’æ‹…ä¿ã§ãã¾ã™ã€‚
å‹ç”Ÿæˆã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ã¯ã€openapi-typescriptã‚’ç”¨ã„ã¦ã„ã¾ã—ãŸã€‚

### openapi-typescript
#### é¸å®šç†ç”±
ã‚ˆã‚Šä¸€èˆ¬çš„ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ã€[OpenAPI Generator](https://github.com/OpenAPITools/openapi-generator)ãŒã‚ã‚Šã¾ã™ã€‚
ã—ã‹ã—ä»¥ä¸‹ã®ç†ç”±ã‹ã‚‰ã€openapi-typescriptã‚’é¸æŠã—ã¾ã—ãŸã€‚
- typescriptè£½ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚Šã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®æŠ€è¡“æ§‹æˆã¨ç›¸æ€§ãŒè‰¯ãã€å†…éƒ¨å®Ÿè£…ã®æŠŠæ¡ã‚„ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®é¢ã§ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚‹
- [transform](https://github.com/drwpow/openapi-typescript#-transform--posttransform:~:text=transform%20/%20postTransform)ã§æŸ”è»Ÿã«å‹ã‚’ç”Ÿæˆã§ãã‚‹ â€»å¾Œè¿°

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
openapi-typescriptã‚’å°å…¥å¾Œã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚

#### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
ä¸‹è¨˜ã¯openapiãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ§‹æˆã§ã™ã€‚
ãªãŠå®Ÿéš›ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª/ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã¯ä¸€éƒ¨ç•°ãªã‚Šã¾ã™ã€‚

```txt
.
â””â”€â”€ openapi
    â”œâ”€â”€ bin
    â”‚   â”œâ”€â”€ generatedTypes.js #src/docsé…ä¸‹ã®å®šç¾©ã‹ã‚‰ã€generatedTypesé…ä¸‹ã«å‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ã€‚
    â”‚   â””â”€â”€ merge.js #defineé…ä¸‹ã®å®šç¾©ã‚’çµåˆã—ã€src/docsé…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ã€‚generatedTypes.jsã®ä¸­ã§å‘¼ã°ã‚Œã‚‹ã€‚
    â”œâ”€â”€ define
    â”‚   â”œâ”€â”€ auth
    â”‚   â”‚   â”œâ”€â”€ components.yml
    â”‚   â”‚   â”œâ”€â”€ path.yml
    â”‚   â”‚   â””â”€â”€ index.yml
    â”‚   â””â”€â”€ users
    â”‚       â”œâ”€â”€ components.yml
    â”‚       â”œâ”€â”€ path.yml
    â”‚       â””â”€â”€ index.yml
    â””â”€â”€ src
        â”œâ”€â”€ docs
        â”‚   â”œâ”€â”€ auth.yml
        â”‚   â””â”€â”€ users.yml
        â”œâ”€â”€ generatedTypes
        â”‚   â”œâ”€â”€ auth.ts
        â”‚   â””â”€â”€ users.ts
        â”œâ”€â”€ types
        â”‚   â”œâ”€â”€ auth.ts #å®Ÿéš›ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰/ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã€‚
        â”‚   â””â”€â”€ users.ts
        â””â”€â”€ utils
            â””â”€â”€ helper.ts #src/typesé…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§åˆ©ç”¨ã•ã‚Œã‚‹ã€‚
```
ç‰¹å¾´ã¨ã—ã¦ã¯ã€ãƒ‰ãƒ¡ã‚¤ãƒ³å˜ä½(auth, users)ã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­ã‘ã¦ã„ã‚‹ç‚¹ã§ã™ã€‚
OASã‚„ãã“ã‹ã‚‰ç”Ÿæˆã™ã‚‹å‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ã‚ã¾ã‚Šã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‚¥å¤§åŒ–ã—ã¦ã—ã¾ã„ã¾ã™ã€‚

#### ã‚¹ã‚¯ãƒªãƒ—ãƒˆåŒ–
``bin/generatedTypes.js``ã¯ã€openapi-typescriptã®APIã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ãã—ã¦ã€``src/generatedTypes``åŠã³``src/docs``é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

``bin/generatedTypes.js``ã®æ¦‚è¦ã§ã™ã€‚
ä¸€éƒ¨åŠ ç­†ã—ã¦ãŠã‚Šã€å®Ÿéš›ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã¯ç•°ãªã‚Šã¾ã™ã€‚

```js
import * as fs from "fs";
import yaml from "js-yaml"
import openapiTS from "openapi-typescript";
import mergeDefine from "./merge.js"

const makeDir = async (dir) => {
  //docsé…ä¸‹ã«æ—¢å­˜ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãªã„å ´åˆã¯ä½œæˆã™ã‚‹ã€‚
  const path = `openapi/src/docs/${dir}`
  if (!fs.existsSync(path)) {
    fs.mkdirSync(path);
  }
}

const callMergeDefine = async (dir) => {
  //bin/merge.jsã‚’å®Ÿè¡Œã™ã‚‹ã€‚defineé…ä¸‹ã®å®šç¾©ã‚’çµåˆã—ã€src/docsé…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹
  const input = `openapi/define/${dir}/index.yml`
  const output = `openapi/src/docs/${dir}/index.yml`
  mergeDefine(input, output)
}

const openapiTSFunc = async (data) => {
  //å‹ã‚’transformã™ã‚‹ã€‚
  const output = await openapiTS(data, {
    formatter(node) {
      if (node.format === "date-time") {
        return "Date"; 
      }
    }
  })
  return output
}

const generateTypes = async (dir) => {
  const filePath = `openapi/src/docs/${dir}/index.yml`
  const fileData = fs.readFileSync(filePath, "utf-8")
  const data = yaml.load(fileData)
  //å‹ã‚’ç”Ÿæˆã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚€ã€‚
  const output = await openapiTSFunc(data)
  fs.writeFileSync(`openapi/src/generatedTypes/${dir}.ts`, output)
}

const main = async () => {
  const defineDirLists = fs.readdirSync('openapi/define')

  await Promise.all(defineDirLists.map(async dir => {
    await makeDir(dir)
    await callMergeDefine(dir)
    await generateTypes(dir)
  }))
}

main()
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€huskyã¨lint-stagedã‚’ç”¨ã„ã¦ã€commitæ™‚ã«è‡ªå‹•ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€é–‹ç™ºè€…é–“ã§ã®QASã‚„ç”Ÿæˆã•ã‚Œã‚‹å‹ãƒ•ã‚¡ã‚¤ãƒ«ã®å·®ç•°ã‚’ãªãã—ã¦ã„ã¾ã™ã€‚

#### transform
è«¸äº‹æƒ…ã‚ã£ã¦ã€è‡ªå‹•ã§ç”Ÿæˆã•ã‚Œã‚‹å‹ã‚’ä»»æ„ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚
openapi-typescriptã®[transform](https://github.com/drwpow/openapi-typescript#-transform--posttransform:~:text=transform%20/%20postTransform)ã¯éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚

```yml
type: object
      properties:
        id:
          type: integer
          format: number-bigint #ä»»æ„ã«å‘½å
          example: 1
```

ã“ã®ã‚ˆã†ã«formatã‚’ä»»æ„ã«å‘½åã—ã¦ãŠãã€ä¸Šè¨˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è¨˜è¿°ã—ãŸã‚ˆã†ã«ã€è‡ªç”±ã«ç”Ÿæˆã•ã‚Œã‚‹å‹ã‚’è¨­å®šã§ãã¾ã™ã€‚


#### helper
openapi-typescriptã®æ®‹å¿µãªç‚¹ã¯ã€ç”Ÿæˆã•ã‚Œã‚‹å‹ãŒãƒã‚¹ãƒˆã•ã‚Œè¤‡é›‘ãªã®ã§ã€ãã®ã¾ã¾ã§ã¯åˆ©ç”¨ã—ã¥ã‚‰ã„ã¨ã“ã‚ã§ã™ã€‚
ãã“ã§``src/types``é…ä¸‹ã«ãŠã„ã¦ã€``utils/helper.ts``ã‚’ç”¨ã„ã¦ã€åˆ©ç”¨ã—ã‚„ã™ã„å‹ã‚’å†å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

##### ç”Ÿæˆã•ã‚Œã‚‹å‹ã®ä¾‹
```typescript
/**
 * This file was auto-generated by openapi-typescript.
 * Do not make direct changes to the file.
 */

export interface paths {
  "/auth": {
    get: {
      responses: {
        200: {
          content: {
            "application/json": {
              key: string
            }[];
          };
        };
        /** Not logged in */
        401: unknown;
        /** Unauthorized */
        403: unknown;
      };
    };
    patch: {
      responses: {
        200: unknown;
        /** Not logged in */
        401: unknown;
        /** Unauthorized */
        403: unknown;
      };
      requestBody: {
        content: {
          "application/json": {
            /** @example 1 */
            id: number;
          }[];
        };
      };
    };
  };
}

export interface components {}

export interface operations {}

export interface external {}
```

##### src/utils/helper.ts
```typescript
type UrlPaths<paths> = keyof paths & string
type HttpMethods = 'patch' | 'get'

export type ResponseBodyType<
  paths extends {
    [k in Path]: {
      [k in Method]: {
        responses: {
          200: {
            content: {
              "application/json": object | Array<object>
            }
          }
        }
      }
    }
  },
  Path extends UrlPaths<paths>,
  Method extends HttpMethods 
> = paths[Path][Method]['responses'][200]['content']["application/json"]

export type RequestBodyType<
  paths extends {
    [k in Path]: {
      [k in Method]: {
        requestBody: {
          content: {
            "application/json": object | Array<object>
          }
        }
      }
    }
  },
  Path extends UrlPaths<paths>,
  Method extends HttpMethods
> = paths[Path][Method]['requestBody']['content']["application/json"]
```

##### openapi/src/types/auth.ts
```typescript
import { RequestBodyType, ResponseBodyType } from '../utils/helper'
import { paths } from '../generatedTypes/settings'

export type getSettingsResponseType = ResponseBodyType<paths, '/auth', 'get'>
export type patchSettingsRequestType = RequestBodyType<paths, '/auth', 'patch'>
```

``getSettingsResponseType``ã‚„``patchSettingsRequestType``ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ»ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§importã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚

## **APIã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«OASã‚’ç”¨ã„ã‚‹**
express-openapi-validatorã¯ã€æ‰‹è»½ã‹ã¤å¼·åŠ›ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦OASã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚

### express-openapi-validator
ä½¿ã„æ–¹ã¯ç°¡å˜ã§ã™ã€‚

ä¸‹è¨˜ã®ã‚ˆã†ã«é–¢æ•°ã‚’ç”¨æ„ã—ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ã—ã¦å„APIã§ä½¿ç”¨ã—ã¾ã™ã€‚

```typescript
// api/src/middlewares/openapiValidator.ts
import { Request, Response, NextFunction } from 'express'
import * as OpenApiValidator from 'express-openapi-validator'
import { OpenApiRequestHandler } from 'express-openapi-validator/dist/framework/types'

export const openApiValidator = (path: string): OpenApiRequestHandler[] => {
  return OpenApiValidator.middleware({
    apiSpec: `../openapi/src/docs/${path}/index.yml`, //èª­ã¿è¾¼ã‚€OASãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
    validateResponses: {
      removeAdditional: true, //OASã«å­˜åœ¨ã—ãªã„ã‚­ãƒ¼ãŒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹å ´åˆã¯å–ã‚Šé™¤ãã€‚
    },
    validateResponses: true,
  })
}

// api/src/router/auth.ts
router.use(openApiValidator('auth'))
```

``openApiValidator``ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æŒ‡å®šã«ã‚ˆã‚Šã€å®šç¾©å¤–ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç™ºç”Ÿã—ãŸå ´åˆã®æŒ™å‹•ã‚’å¤šæ§˜ã«è¨­å®šã§ãã¾ã™ã€‚

## ã¾ã¨ã‚
æœ¬è¨˜äº‹ã§ã¯ã€OASã‚’ç”¨ã„ãŸä¸‹è¨˜2ç‚¹ã®æ´»ç”¨ã«ã¤ã„ã¦è¿°ã¹ã¾ã—ãŸã€‚
1. openapi-typescriptã‚’ç”¨ã„ã¦ã€å‹ã‚’ç”Ÿæˆã—ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ»ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å…±ç”¨ã™ã‚‹
2. express-openapi-validatorã‚’ç”¨ã„ã¦ã€APIã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹

ã“ã‚Œã‚‰ã®æ´»ç”¨ã«ã‚ˆã£ã¦ã€ã‚ˆã‚ŠOASã«ä¾å­˜ã—ãŸã‚¹ã‚­ãƒ¼ãƒé§†å‹•ã®é–‹ç™ºã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ»ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åŒæ–¹ãŒOASã«ä¾å­˜ã™ã‚‹ã“ã¨ã§ã€ã‚³ãƒ¼ãƒ‰ã®å“è³ªã‚’æ‹…ä¿ã—ã€ãƒã‚°ã®ç™ºç”Ÿã‚’é˜²ãã¾ã™ã€‚

å°‘ã—ã§ã‚‚ã”å‚è€ƒã«ãªã‚Œã°ã€å¹¸ã„ã§ã™ã€‚











